<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹¨êµíƒíŒŒ ì¡±ë³´ ë·°ì–´ (Layout Fix)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Malgun Gothic', sans-serif; }
        
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 20px; font-weight: bold; flex-direction: column; gap: 10px;
            transition: opacity 0.5s;
        }

        #controls {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0, 0, 0, 0.8); box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000; display: flex; align-items: center; justify-content: center; gap: 10px;
            backdrop-filter: blur(5px);
        }
        input { padding: 10px; border: 1px solid #555; background: #333; color: white; border-radius: 4px; width: 150px; font-size: 16px; outline: none; }
        button { padding: 10px 20px; cursor: pointer; background: #444; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #666; }
        button.action-btn { background: #007bff; }
        button.dev-btn { background: #d9534f; font-size: 12px; padding: 5px 10px; display: none;} 

        /* [í•µì‹¬ ìˆ˜ì • 1] Flex ì œê±° -> blockìœ¼ë¡œ ë³€ê²½ */
        #viewport { 
            width: 100vw; height: 100vh; 
            overflow: hidden; 
            position: relative; /* ìì‹ absolute ê¸°ì¤€ì  */
            cursor: grab; 
            background-color: #222;
        }
        #viewport:active { cursor: grabbing; }
        
        /* [í•µì‹¬ ìˆ˜ì • 2] ì´ë¯¸ì§€ë¥¼ ë¬´ì¡°ê±´ 0,0 ì¢Œí‘œì—ì„œ ì‹œì‘í•˜ê²Œ ê³ ì • */
        #image-container { 
            position: absolute; 
            top: 0; 
            left: 0;
            transform-origin: 0 0; 
            will-change: transform;
        }
        
        #jocbo-img { display: block; pointer-events: none; user-select: none; }

        #marker-box {
            position: absolute; border: 4px solid #ff0000; background-color: rgba(255, 255, 0, 0.2);
            border-radius: 8px; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            display: none; z-index: 10; pointer-events: none;
        }
        #marker-box::after {
            content: "ğŸ‘‡ ì—¬ê¸°!"; position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            color: #ff0000; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 0 #fff;
            white-space: nowrap; animation: bounce 1s infinite;
        }
        @keyframes bounce { 0%, 100% { top: -35px; } 50% { top: -45px; } }

        .dev-mode #viewport { cursor: crosshair !important; }
        .dev-mode #jocbo-img { pointer-events: auto; }
    </style>
</head>
<body>

    <div id="loading-mask">
        <span id="loading-text">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</span>
    </div>

    <div id="controls">
        <input type="text" id="searchInput" placeholder="ì´ë¦„ ì…ë ¥ (Enter)" onkeyup="if(window.event.keyCode==13){findName()}">
        <button onclick="findName()" class="action-btn">ê²€ìƒ‰</button>
        <button onclick="centerImage(true)">ì „ì²´ë³´ê¸°</button>
        <button onclick="toggleDevMode()" class="dev-btn" id="devBtn">ğŸ›  ì¢Œí‘œë”°ê¸°</button>
    </div>

    <div id="viewport">
        <div id="image-container">
            <img src="jocbo.jpeg" id="jocbo-img" alt="ì¡±ë³´">
            <div id="marker-box"></div>
        </div>
    </div>

    <script>
        let nameDB = [];

        window.onload = async function() {
            // 1. ì„¤ì • ë° DB ë¡œë“œ
            try {
                const confRes = await fetch('/config');
                const config = await confRes.json();
                if (config.edit_mode) document.getElementById('devBtn').style.display = 'block';
            } catch (e) {}

            try {
                const response = await fetch('db.json?t=' + new Date().getTime());
                if (response.ok) nameDB = await response.json();
            } catch (error) { nameDB = []; }

            // 2. ì´ë¯¸ì§€ ë¡œë”© ì²´í¬
            checkImageStatus();
        };

        function checkImageStatus() {
            const img = document.getElementById('jocbo-img');
            if (img.complete && img.naturalWidth > 0) {
                // ë¡œë”© ì™„ë£Œ í›„ ì¦‰ì‹œ ì‹¤í–‰
                centerImage(true);
            } else {
                setTimeout(checkImageStatus, 100);
            }
        }

        // =========================================================
        // [Viewer Logic]
        // =========================================================
        let scale = 1; let pointX = 0, pointY = 0;
        let isDragging = false, startX, startY;
        const container = document.getElementById('image-container');
        const viewport = document.getElementById('viewport');
        const img = document.getElementById('jocbo-img');
        const mask = document.getElementById('loading-mask');

        function updateTransform() { 
            container.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; 
        }

        function centerImage(forceReset = false) {
            const imgW = img.naturalWidth; const imgH = img.naturalHeight;
            const viewW = window.innerWidth; const viewH = window.innerHeight;

            if (!imgW) return;

            // 1. í™”ë©´ì˜ 95% í¬ê¸°ë¡œ ë§ì¶¤ (ì•½ê°„ì˜ ì—¬ë°±)
            scale = Math.min(viewW / imgW, viewH / imgH) * 0.95;
            
            // 2. ì •í™•í•œ ì¤‘ì•™ ì¢Œí‘œ ê³„ì‚° (0,0 ê¸°ì¤€)
            pointX = (viewW - (imgW * scale)) / 2;
            pointY = (viewH - (imgH * scale)) / 2;

            updateTransform();
            
            if (forceReset) document.getElementById('marker-box').style.display = 'none';

            // ë¡œë”© ë§ˆìŠ¤í¬ ì œê±°
            mask.style.opacity = 0;
            setTimeout(() => { mask.style.display = 'none'; }, 500);
        }

        // ìœˆë„ìš° í¬ê¸° ë³€ê²½ ëŒ€ì‘
        window.addEventListener('resize', () => {
             if(document.getElementById('marker-box').style.display === 'none') centerImage(false);
        });

        viewport.addEventListener('mousedown', (e) => {
            if (isDevMode) return;
            isDragging = true; startX = e.clientX - pointX; startY = e.clientY - pointY;
        });
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault(); pointX = e.clientX - startX; pointY = e.clientY - startY; updateTransform();
        });
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = -e.deltaY;
            const xs = (e.clientX - pointX) / scale; const ys = (e.clientY - pointY) / scale;
            (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
            pointX = e.clientX - xs * scale; pointY = e.clientY - ys * scale;
            updateTransform();
        });

        function findName() {
            const input = document.getElementById('searchInput').value.trim();
            if (!input) return;
            const targets = nameDB.slice().reverse().filter(item => item.n === input || item.n.includes(input));

            if (targets.length > 0) {
                const target = targets[0];
                const imgW = img.naturalWidth; const imgH = img.naturalHeight;
                const realX = (target.x / 100) * imgW; const realY = (target.y / 100) * imgH;
                const marker = document.getElementById('marker-box');
                marker.style.display = 'block';
                marker.style.width = (imgW * 0.04) + 'px'; marker.style.height = (imgH * 0.025) + 'px';
                marker.style.left = (realX - (imgW * 0.02)) + 'px'; marker.style.top = (realY - (imgH * 0.012)) + 'px';
                scale = 1.0; 
                pointX = (window.innerWidth / 2) - (realX * scale); pointY = (window.innerHeight / 2) - (realY * scale);
                updateTransform();
            } else { alert("ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤."); }
        }

        // ê°œë°œ ëª¨ë“œ
        let isDevMode = false;
        function toggleDevMode() {
            isDevMode = !isDevMode;
            const btn = document.getElementById('devBtn');
            const body = document.body;
            if (isDevMode) {
                btn.innerText = "ì´ë¦„ì„ í´ë¦­í•˜ì„¸ìš”"; btn.style.background = "#28a745"; body.classList.add('dev-mode');
            } else {
                btn.innerText = "ğŸ›  ì¢Œí‘œë”°ê¸°"; btn.style.background = "#d9534f"; body.classList.remove('dev-mode');
            }
        }

        img.addEventListener('click', (e) => {
            if (!isDevMode) return;
            const rect = img.getBoundingClientRect();
            // í´ë¦­ ì´ë²¤íŠ¸ ì¢Œí‘œ ë³´ì •
            const perX = ((e.clientX - rect.left) / rect.width) * 100;
            const perY = ((e.clientY - rect.top) / rect.height) * 100;
            const name = prompt(`ì¢Œí‘œ ì €ì¥!\nì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:`);
            if (name) {
                const newData = { n: name, x: parseFloat(perX.toFixed(2)), y: parseFloat(perY.toFixed(2)) };
                fetch('/add_coordinate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newData)
                })
                .then(res => {
                    if (res.ok) { nameDB.push(newData); alert("ì €ì¥ ì™„ë£Œ!"); }
                    else alert("ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
                });
            }
        });
    </script>
</body>
</html>