<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹¨êµíƒíŒŒ ì¡±ë³´ ë·°ì–´</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: 'Malgun Gothic', serif; }
        
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #222; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 20px; font-weight: bold; flex-direction: column; gap: 10px;
            transition: opacity 0.5s;
        }

        #controls {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0, 0, 0, 0.8); box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 1000; display: flex; align-items: center; justify-content: center; gap: 10px;
            backdrop-filter: blur(5px);
        }
        input { padding: 10px; border: 1px solid #555; background: #333; color: white; border-radius: 4px; width: 150px; font-size: 16px; outline: none; }
        button { padding: 10px 20px; cursor: pointer; background: #444; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #666; }
        button.action-btn { background: #007bff; }
        button.dev-btn { background: #d9534f; font-size: 12px; padding: 5px 10px; display: none;} 

        #viewport { width: 100vw; height: 100vh; overflow: hidden; position: relative; cursor: grab; background-color: #222; }
        #viewport:active { cursor: grabbing; }
        
        #image-container { position: absolute; top: 0; left: 0; transform-origin: 0 0; will-change: transform; }
        #jocbo-img { display: block; pointer-events: none; user-select: none; }

        /* ê²€ìƒ‰ ë§ˆì»¤ */
        #marker-box {
            position: absolute; border: 4px solid #ff0000; background-color: rgba(255, 255, 0, 0.2);
            border-radius: 8px; box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            display: none; z-index: 20; pointer-events: none;
        }

        /* ìƒˆ ì¸ë¬¼ ìŠ¤í‹°ì»¤ */
        .new-person {
            position: absolute; background: white; border: 1px solid #333;
            padding: 2px 4px; font-weight: bold; color: black; text-align: center;
            transform: translate(-50%, -50%); box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap; z-index: 5;
        }

        /* [NEW] ì»¤ìŠ¤í…€ ì…ë ¥ì°½ (ëª¨ë‹¬) ìŠ¤íƒ€ì¼ */
        #custom-modal {
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 10000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #333; color: white; padding: 20px; border-radius: 10px;
            width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .modal-content h3 { margin-top: 0; color: #fff; }
        .modal-content input { width: 80%; margin-bottom: 20px; text-align: center; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; }
        .modal-btns button { width: 100%; }
        .btn-edit { background: #17a2b8; }
        .btn-new { background: #28a745; }
        .btn-cancel { background: #6c757d; }

        .dev-mode #viewport { cursor: crosshair !important; }
        .dev-mode #jocbo-img { pointer-events: auto; }
    </style>
</head>
<body>

    <div id="loading-mask"><span id="loading-text">ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</span></div>

    <div id="controls">
        <input type="text" id="searchInput" placeholder="ì´ë¦„ ì…ë ¥ (Enter)" onkeyup="if(window.event.keyCode==13){findName()}">
        <button onclick="findName()" class="action-btn">ê²€ìƒ‰</button>
        <button onclick="centerImage(true)">ì „ì²´ë³´ê¸°</button>
        <button onclick="toggleDevMode()" class="dev-btn" id="devBtn">ğŸ›  ê´€ë¦¬ì ëª¨ë“œ</button>
    </div>

    <div id="viewport">
        <div id="image-container">
            <img src="jocbo.jpeg" id="jocbo-img" alt="ì¡±ë³´">
            <div id="marker-box"></div>
            <div id="overlay-layer"></div>
        </div>
    </div>

    <div id="custom-modal">
        <div class="modal-content">
            <h3>ë°ì´í„° ì…ë ¥</h3>
            <p style="font-size: 12px; color: #ccc;">í´ë¦­í•œ ìœ„ì¹˜ì— ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</p>
            <input type="text" id="modal-name-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div class="modal-btns">
                <button class="btn-edit" onclick="saveData('edit')">ğŸ“ ê¸°ì¡´ ìœ„ì¹˜ë§Œ ìˆ˜ì •</button>
                <button class="btn-new" onclick="saveData('new')">âœ¨ ìƒˆ ì¸ë¬¼ ì¶”ê°€ (ë°•ìŠ¤ ìƒì„±)</button>
                <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        let nameDB = [];
        // í´ë¦­í•œ ì¢Œí‘œ ì„ì‹œ ì €ì¥ìš© ë³€ìˆ˜
        let tempX = 0;
        let tempY = 0;

        window.onload = async function() {
            try {
                const confRes = await fetch('/config');
                const config = await confRes.json();
                if (config.edit_mode) document.getElementById('devBtn').style.display = 'block';
            } catch (e) {}

            try {
                const response = await fetch('db.json?t=' + new Date().getTime());
                if (response.ok) {
                    nameDB = await response.json();
                    drawOverlays();
                }
            } catch (error) { nameDB = []; }
            checkImageStatus();
        };

        function checkImageStatus() {
            const img = document.getElementById('jocbo-img');
            if (img.complete && img.naturalWidth > 0) centerImage(true);
            else setTimeout(checkImageStatus, 100);
        }

        function drawOverlays() {
            const layer = document.getElementById('overlay-layer');
            const img = document.getElementById('jocbo-img');
            if (!img.naturalWidth) { setTimeout(drawOverlays, 100); return; }

            layer.innerHTML = '';
            nameDB.forEach(person => {
                if (person.type === "new") {
                    const div = document.createElement('div');
                    div.className = 'new-person';
                    div.innerText = person.n;
                    div.style.left = person.x + '%';
                    div.style.top = person.y + '%';
                    const fontSize = Math.max(12, img.naturalWidth * 0.006); 
                    div.style.fontSize = fontSize + 'px';
                    layer.appendChild(div);
                }
            });
        }

        // --- ë·°ì–´ ë¡œì§ ---
        let scale = 1, pX = 0, pY = 0, isDragging = false, sX, sY;
        const con = document.getElementById('image-container');
        const img = document.getElementById('jocbo-img');
        const mask = document.getElementById('loading-mask');

        function updateTransform() { con.style.transform = `translate(${pX}px, ${pY}px) scale(${scale})`; }

        function centerImage(reset = false) {
            const iW = img.naturalWidth, iH = img.naturalHeight;
            if (!iW) return;
            scale = Math.min(innerWidth / iW, innerHeight / iH) * 0.95;
            pX = (innerWidth - (iW * scale)) / 2;
            pY = (innerHeight - (iH * scale)) / 2;
            updateTransform();
            if (reset) document.getElementById('marker-box').style.display = 'none';
            mask.style.opacity = 0; setTimeout(() => { mask.style.display = 'none'; }, 500);
        }

        const vp = document.getElementById('viewport');
        vp.onmousedown = e => { if(!isDevMode) { isDragging=true; sX=e.clientX-pX; sY=e.clientY-pY; }};
        window.onmouseup = () => isDragging=false;
        window.onmousemove = e => { if(isDragging) { e.preventDefault(); pX=e.clientX-sX; pY=e.clientY-sY; updateTransform(); }};
        vp.onwheel = e => { e.preventDefault(); const d = -e.deltaY>0?1.1:0.9; const xs=(e.clientX-pX)/scale, ys=(e.clientY-pY)/scale; scale*=d; pX=e.clientX-xs*scale; pY=e.clientY-ys*scale; updateTransform(); };

        function findName() {
            const val = document.getElementById('searchInput').value.trim();
            if(!val) return;
            const found = nameDB.slice().reverse().find(i => i.n === val || i.n.includes(val));
            if(found) {
                const iW = img.naturalWidth, iH = img.naturalHeight;
                const rX = (found.x/100)*iW, rY = (found.y/100)*iH;
                const mk = document.getElementById('marker-box');
                mk.style.display='block';
                mk.style.width = (iW*0.04)+'px'; mk.style.height = (iH*0.025)+'px';
                mk.style.left = (rX - iW*0.02)+'px'; mk.style.top = (rY - iH*0.012)+'px';
                scale=1; pX=innerWidth/2 - rX*scale; pY=innerHeight/2 - rY*scale; updateTransform();
            } else alert("ì—†ìŠµë‹ˆë‹¤.");
        }

        // --- ê´€ë¦¬ì ëª¨ë“œ ë¡œì§ ---
        let isDevMode = false;
        function toggleDevMode() {
            isDevMode = !isDevMode;
            const btn = document.getElementById('devBtn');
            const body = document.body;
            if (isDevMode) {
                btn.innerText = "í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”"; btn.style.background = "#28a745"; body.classList.add('dev-mode');
            } else {
                btn.innerText = "ğŸ›  ê´€ë¦¬ì ëª¨ë“œ"; btn.style.background = "#d9534f"; body.classList.remove('dev-mode');
            }
        }

        // ì´ë¯¸ì§€ í´ë¦­ ì‹œ ëª¨ë‹¬ì°½ ë„ìš°ê¸°
        img.onclick = e => {
            if(!isDevMode) return;
            const r = img.getBoundingClientRect();
            // ì¢Œí‘œ ì „ì—­ë³€ìˆ˜ì— ì €ì¥
            tempX = ((e.clientX - r.left)/r.width)*100;
            tempY = ((e.clientY - r.top)/r.height)*100;
            
            // ëª¨ë‹¬ì°½ ë³´ì´ê¸°
            document.getElementById('modal-name-input').value = "";
            document.getElementById('custom-modal').style.display = "flex";
            document.getElementById('modal-name-input').focus();
        };

        // ë°ì´í„° ì €ì¥ (ëª¨ë‹¬ì°½ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)
        function saveData(mode) {
            const name = document.getElementById('modal-name-input').value.trim();
            if (!name) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

            const data = { n: name, x: parseFloat(tempX.toFixed(2)), y: parseFloat(tempY.toFixed(2)) };
            
            // ëª¨ë“œì— ë”°ë¼ type ì¶”ê°€
            if (mode === 'new') {
                data.type = "new";
            }

            fetch('/add_coordinate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(res => {
                if(res.ok) {
                    // ê¸°ì¡´ ë™ì¼ ì´ë¦„ ì œê±° í›„ ì¶”ê°€ (ì—…ë°ì´íŠ¸ íš¨ê³¼)
                    nameDB = nameDB.filter(p => p.n !== name);
                    nameDB.push(data);
                    drawOverlays(); // í™”ë©´ ê°±ì‹ 
                    closeModal(); // ì°½ ë‹«ê¸°
                    alert("ì €ì¥ ì™„ë£Œ!");
                } else {
                    alert("ì˜¤ë¥˜: ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        }

        function closeModal() {
            document.getElementById('custom-modal').style.display = "none";
        }
    </script>
</body>
</html>
